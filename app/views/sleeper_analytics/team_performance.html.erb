<div class="row">
  <div class="col-12">
    <h1>üìà Team Performance Analysis</h1>
    <p class="text-muted">Track performance trends and identify consistently strong managers</p>
  </div>
</div>

<!-- Navigation -->
<div class="row mb-3">
  <div class="col-12">
    <%= link_to "‚Üê Back to Dashboard", sleeper_analytics_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<!-- Performance by Team -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5>Multi-Season Performance Overview</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Team Manager</th>
                <% @team_stats.values.first&.keys&.sort&.each do |season| %>
                  <th class="text-center"><%= season %></th>
                <% end %>
                <th class="text-center">Trend</th>
                <th class="text-center">Consistency</th>
              </tr>
            </thead>
            <tbody>
              <% @team_stats.each do |manager, seasons_data| %>
                <tr>
                  <td>
                    <strong><%= manager %></strong>
                    <% if @team_trends[manager] %>
                      <br>
                      <small class="text-muted">
                        <% trend = @team_trends[manager][:points_trend] %>
                        <span class="badge bg-<%= trend > 0 ? 'success' : trend < 0 ? 'danger' : 'secondary' %>">
                          <%= trend > 0 ? '‚Üó' : trend < 0 ? '‚Üò' : '‚Üí' %> 
                          <%= trend.abs.round(1) %> pts
                        </span>
                      </small>
                    <% end %>
                  </td>
                  
                  <% seasons_data.sort_by { |season, _| season }.each do |season, stats| %>
                    <td class="text-center">
                      <div>
                        <strong><%= stats[:wins] %>-<%= stats[:losses] %></strong>
                        <% if stats[:ties] > 0 %>-<%= stats[:ties] %><% end %>
                      </div>
                      <small class="text-muted">
                        <%= stats[:avg_points] %> pts/wk
                      </small>
                      <br>
                      <span class="badge bg-<%= stats[:win_percentage] > 0.6 ? 'success' : stats[:win_percentage] > 0.4 ? 'warning' : 'danger' %>">
                        <%= (stats[:win_percentage] * 100).round(1) %>%
                      </span>
                    </td>
                  <% end %>
                  
                  <td class="text-center">
                    <% if @team_trends[manager] %>
                      <% wins_trend = @team_trends[manager][:wins_trend] %>
                      <span class="badge bg-<%= wins_trend > 0 ? 'success' : wins_trend < 0 ? 'danger' : 'secondary' %>">
                        <%= wins_trend > 0 ? '+' : '' %><%= wins_trend %> wins
                      </span>
                    <% else %>
                      <span class="text-muted">N/A</span>
                    <% end %>
                  </td>
                  
                  <td class="text-center">
                    <% if @team_trends[manager] %>
                      <% consistency = @team_trends[manager][:consistency] %>
                      <span class="badge bg-<%= consistency < 10 ? 'success' : consistency < 20 ? 'warning' : 'danger' %>">
                        <%= consistency < 10 ? 'High' : consistency < 20 ? 'Medium' : 'Low' %>
                      </span>
                      <br>
                      <small class="text-muted">œÉ = <%= consistency %></small>
                    <% else %>
                      <span class="text-muted">N/A</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- League Insights -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5>üèÜ Top Performers</h5>
      </div>
      <div class="card-body">
        <% 
          # Calculate overall performance rankings
          overall_performance = @team_stats.map do |manager, seasons_data|
            total_wins = seasons_data.values.sum { |s| s[:wins] }
            total_games = seasons_data.values.sum { |s| s[:wins] + s[:losses] + s[:ties] }
            avg_win_pct = total_games > 0 ? total_wins.to_f / total_games : 0
            avg_points = seasons_data.values.map { |s| s[:avg_points] }.sum / seasons_data.size
            
            { manager: manager, win_pct: avg_win_pct, avg_points: avg_points, total_wins: total_wins }
          end.sort_by { |p| -p[:win_pct] }
        %>
        
        <% overall_performance.first(5).each_with_index do |performer, index| %>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong><%= "#{index + 1}. #{performer[:manager]}" %></strong>
              <br>
              <small class="text-muted">
                <%= performer[:avg_points].round(1) %> pts/wk avg
              </small>
            </div>
            <div class="text-end">
              <span class="badge bg-success">
                <%= (performer[:win_pct] * 100).round(1) %>%
              </span>
              <br>
              <small class="text-muted">
                <%= performer[:total_wins] %> total wins
              </small>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5>üìä League Dynamics</h5>
      </div>
      <div class="card-body">
        <h6>Competitive Balance</h6>
        <% 
          win_percentages = overall_performance.map { |p| p[:win_pct] }
          parity = win_percentages.max - win_percentages.min
        %>
        <p>
          <span class="badge bg-<%= parity < 0.3 ? 'success' : parity < 0.5 ? 'warning' : 'danger' %>">
            <%= parity < 0.3 ? 'High Parity' : parity < 0.5 ? 'Moderate Parity' : 'Low Parity' %>
          </span>
          <br>
          <small class="text-muted">
            Win % range: <%= (win_percentages.min * 100).round(1) %>% - <%= (win_percentages.max * 100).round(1) %>%
          </small>
        </p>
        
        <h6>Most Consistent</h6>
        <% 
          most_consistent = @team_trends.min_by { |_, trends| trends[:consistency] }
        %>
        <% if most_consistent %>
          <p>
            <strong><%= most_consistent[0] %></strong>
            <br>
            <small class="text-muted">
              Lowest scoring variance (œÉ = <%= most_consistent[1][:consistency] %>)
            </small>
          </p>
        <% end %>
        
        <h6>Biggest Improver</h6>
        <% 
          biggest_improver = @team_trends.max_by { |_, trends| trends[:points_trend] }
        %>
        <% if biggest_improver %>
          <p>
            <strong><%= biggest_improver[0] %></strong>
            <br>
            <small class="text-muted">
              +<%= biggest_improver[1][:points_trend].round(1) %> pts/week improvement
            </small>
          </p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- 2025 Insights -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-info">
      <div class="card-header bg-info text-white">
        <h5>üîÆ 2025 Draft Strategy Insights</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <h6>üéØ Target Opponents</h6>
            <% 
              struggling_teams = overall_performance.last(3)
            %>
            <ul class="list-unstyled">
              <% struggling_teams.each do |team| %>
                <li>‚Ä¢ <strong><%= team[:manager] %></strong> - <%= (team[:win_pct] * 100).round(1) %>% win rate</li>
              <% end %>
            </ul>
            <small class="text-muted">Teams with historically lower performance - potential trade targets</small>
          </div>
          
          <div class="col-md-4">
            <h6>‚ö†Ô∏è Watch Out For</h6>
            <% 
              top_teams = overall_performance.first(3)
            %>
            <ul class="list-unstyled">
              <% top_teams.each do |team| %>
                <li>‚Ä¢ <strong><%= team[:manager] %></strong> - <%= (team[:win_pct] * 100).round(1) %>% win rate</li>
              <% end %>
            </ul>
            <small class="text-muted">Consistently strong managers - expect strong draft competition</small>
          </div>
          
          <div class="col-md-4">
            <h6>üìà Trending Up</h6>
            <% 
              improving_teams = @team_trends.select { |_, trends| trends[:points_trend] > 5 }
                                             .sort_by { |_, trends| -trends[:points_trend] }
                                             .first(3)
            %>
            <% if improving_teams.any? %>
              <ul class="list-unstyled">
                <% improving_teams.each do |manager, trends| %>
                  <li>‚Ä¢ <strong><%= manager %></strong> - +<%= trends[:points_trend].round(1) %> pts</li>
                <% end %>
              </ul>
              <small class="text-muted">Teams improving significantly - rising threats</small>
            <% else %>
              <p class="text-muted">No significant improving trends detected</p>
            <% end %>
          </div>
        </div>
        
        <div class="mt-3">
          <%= link_to draft_analysis_sleeper_analytics_path, class: "btn btn-info me-2" do %>
            ‚Üê Back to Draft Analysis
          <% end %>
          <%= link_to player_performance_sleeper_analytics_path, class: "btn btn-outline-info" do %>
            Analyze Player Trends ‚Üí
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <h1>Fantasy Football Analytics Dashboard</h1>
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><%= @season %> Season</h2>
      <div>
        <%= form_with url: analytics_path, method: :get, local: true, class: "d-flex" do |f| %>
          <%= f.select :season, options_for_select((2020..Date.current.year).map { |y| [y, y] }, @season), 
                      { prompt: "Select Season" }, { class: "form-select me-2" } %>
          <%= f.submit "Change Season", class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <% %w[QB RB WR TE].each do |position| %>
    <div class="col-md-6 col-lg-3 mb-4">
      <div class="card">
        <div class="card-header">
          <h5><%= position %> Analysis</h5>
        </div>
        <div class="card-body">
          <% if @position_data[position][:top_performers].any? %>
            <h6>Top Performers</h6>
            <% @position_data[position][:top_performers].first(3).each do |performer| %>
              <div class="mb-2">
                <%= link_to performer[:player].name,
                    analytics_path(performer[:player], season: @season),
                    class: "text-decoration-none" %>
                <small class="text-muted d-block">
                  <%= performer[:fantasy_points].round(1) %> pts
                </small>
              </div>
            <% end %>

            <hr>

            <% if @position_data[position][:sleepers].any? %>
              <h6 class="text-success">Sleeper Picks</h6>
              <% @position_data[position][:sleepers].first(2).each do |sleeper| %>
                <div class="small text-success">
                  <%= sleeper[:player].name %>
                  <span class="text-muted">
                    (Eff: <%= sleeper[:efficiency_score] %>)
                  </span>
                </div>
              <% end %>
            <% end %>

            <div class="mt-3">
              <%= link_to "View All #{position}s",
                  rankings_analytics_path(position: position, season: @season),
                  class: "btn btn-sm btn-outline-primary" %>
            </div>
          <% else %>
            <p class="text-muted">No data available for <%= @season %></p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5>Position Scarcity Analysis</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <% %w[QB RB WR TE].each do |position| %>
            <div class="col-md-3">
              <h6><%= position %></h6>
              <% if @position_data[position][:scarcity].any? %>
                <% @position_data[position][:scarcity].each do |tier_transition, data| %>
                  <small class="d-block">
                    <%= tier_transition.humanize %>:
                    <span class="text-<%= data[:drop_off_percent] > 15 ? 'danger' : 'warning' %>">
                      <%= data[:drop_off_percent] %>% drop
                    </span>
                  </small>
                <% end %>
              <% else %>
                <small class="text-muted">No scarcity data</small>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
